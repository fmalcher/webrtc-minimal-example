<html>
<head>
<title>WebRTC Minimal Example</title>
</head>

<body>
<script>
const me = 'alice';
const partner = 'bob';
</script>

<link rel="stylesheet" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css">
<script src="https://unpkg.com/webrtc-adapter@latest/out/adapter.js"></script>
<script src="helpers.js"></script>

<script>
var iceActive = false; // Do we already transmit ICE candidates?
var iceBuffer = [];

// websocket connection
var conn = new WebSocket(WEBSOCKET_URL);

/*************************************/

// create a peer connection
var pc = new RTCPeerConnection(RTCPC_CONFIG_A);

// event handler for when remote stream is added to peer connection
pc.onaddstream = obj => {
    console.log('onaddstream', pc);
    document.getElementById('remoteVideo').srcObject = obj.stream;
}

// event handler for when local ICE candidate has been found
pc.onicecandidate = e => {
    let cand = e.candidate;

    // end if candidate is null (last candidate is!)
    if(!cand) return;

    // if ICE not enabled yet, push to buffer first
    if(!iceActive) {
        iceBuffer.push(cand);
    } else {
        sendIceCandidate(cand);
    }
}

/*************************************/

// invite a partner p (Bob) to a call
function invite(partner) {
    navigator.mediaDevices.getUserMedia({ audio: true, video: true })
        .then(stream => {
            document.getElementById('localVideo').srcObject = stream;
            pc.addStream(stream);

            pc.createOffer({
                offerToReceiveAudio: 1,
                offerToReceiveVideo: 1
            }).then(offer => {
                pc.setLocalDescription(offer, () => {
                    let msg = {
                        type: 'invitation',
                        offer: offer,
                        to: partner
                    }
                    sendMessage(partner, msg);
                },
                e => console.log(e));
            });
        });
}

// close peer connection
function closePC() {
    pc.close();
}


/**************************************
* Message handling
**************************************/

// handler for all incoming messages
conn.onmessage = msg => {
    var data = JSON.parse(msg.data);

    switch(data.body.type){
        case 'accepted':     handleAccepted(data); break;
        case 'icecandidate': handleIceCandidate(data); break;
    }
}


// handler for accepted call from Bob
function handleAccepted(msg) {
    let answer = msg.body.answer;
    console.log('received answer', answer);

    pc.setRemoteDescription(new RTCSessionDescription(answer), () => {
        // send all ice candidates to Bob
        emptyIceBuffer();
    },
    e => console.log(e));
}


// handler for received ICE candidate from partner
function handleIceCandidate(msg) {
    let cand = new RTCIceCandidate(msg.body.candidate);
    pc.addIceCandidate(cand);
}

</script>

<div class="container">
    <h2>Alice</h2>
    <button onClick="login(me)" class="btn btn-success btn-lg">Login</button>
    <button onClick="invite(partner)" class="btn btn-primary btn-lg">Invite Bob</button>
    <button onClick="closePC()" class="btn btn-danger btn-lg">Close Peer Connection</button>
    <hr>

    <video id="remoteVideo" autoplay controls style="width: 500px; float: left; margin-right: 20px; border: 1px solid grey;"></video>
    <video id="localVideo" autoplay controls style="width: 200px; border: 1px solid grey;"></video>
</div>

</body>
</html>
