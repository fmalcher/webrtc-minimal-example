<html>
<head>
<title>WebRTC Minimal Example</title>

<script src="node_modules/webrtc-adapter-test/adapter.js"></script>
</head>

<body>
<script>
var me = null;
var partner = null;
var pc = null;

var ice = false;
var iceBuffer = [];

var constraints = {
    audio: false,
    video: true
};

var conn = new WebSocket('ws://10.26.6.50:1337');

//handler for incoming messages
conn.onmessage = function(msg){
    var data = JSON.parse(msg.data);

    switch(data.body.type){
        case 'invitation': handleInvite(data); break;
        case 'accepted': handleAccepted(data); break;
        case 'icecandidate': handleIceCandidate(data); break;
    }
}

//create a peer connection with its event handlers
function createPC(){
    pc = new RTCPeerConnection();

    //event handler for when remote stream is added to peer connection
    pc.onaddstream = function(obj){
        console.log('onaddstream', pc);
        document.getElementById('remoteVideo').srcObject = obj.stream;
    }

    //event handler for when local ice candidate has been found
    pc.onicecandidate = function(e){
        var cand = e.candidate;

        //end if candidate is null (last candidate is!)
        if(!cand) return;

        //if ice not enabled yet, push to buffer first
        if(!ice){
            iceBuffer.push(cand);
        }else{
            sendIceCandidate(cand);
        }


    }
}

//send all ICE candidates from buffer to partner
function emptyIceBuffer(){
    ice = true;

    //send ice candidates from buffer
    for(var i = (iceBuffer.length - 1); i >= 0; i--){
        sendIceCandidate(iceBuffer[i]);
        iceBuffer.splice(i, 1);
    }
}

//send one ICE candidate to partner
function sendIceCandidate(cand){
    var msg = {
        type: 'icecandidate',
        to: partner,
        candidate: cand
    }

    message(partner, msg);
}

//handler for received ICE candidate from partner
function handleIceCandidate(msg){
    var cand = new RTCIceCandidate(msg.body.candidate);

    pc.addIceCandidate(cand);
}


//Alice: invite a partner p (Bob) to a call
function invite(p){
    //write partner to global var
    partner = p;

    createPC();

    navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
        document.getElementById('localVideo').srcObject = stream;
        pc.addStream(stream);

        pc.createOffer({
            offerToReceiveAudio: 1,
            offerToReceiveVideo: 1
        }).then(function(offer){
            pc.setLocalDescription(new RTCSessionDescription(offer), function(){
                var msg = {
                    type: 'invitation',
                    offer: offer,
                    to: partner
                }
                message(partner, msg);
            })
        });
    });




}


//Bob: handle incoming invite from Alice
function handleInvite(msg){
    console.log('got invite from', msg.from);
    partner = msg.from;

    //confirmation dialog
    if(!confirm('Incoming call from ' + msg.from + '. Answer?')) return;

    createPC();

    var offer = msg.body.offer;

    console.log('received offer', offer);



    navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
        //pc.onaddstream({stream: stream});
        document.getElementById('localVideo').srcObject = stream;
        pc.addStream(stream);

        pc.setRemoteDescription(new RTCSessionDescription(offer), function(){
            pc.createAnswer().then(function(answer){
                pc.setLocalDescription(new RTCSessionDescription(answer), function(){
                    var send = {
                        type: 'accepted',
                        to: partner,
                        answer: answer
                    }
                    message(partner, send);

                    //send all ice candidates
                    emptyIceBuffer();
                });
            });
        });
    });
}


//Alice: handle accepted call from Bob
function handleAccepted(msg){
    var answer = msg.body.answer;
    console.log('received answer', answer);
    pc.setRemoteDescription(new RTCSessionDescription(answer), function(){

        //send all ice candidates
        emptyIceBuffer();
    });
}




//login with user name
function login(name){
    //set name globally
    me = name;
    document.getElementById('myName').innerHTML = me;

    console.log('logging in as', name);

    var msg = {
        type: 'login',
        from: name
    }
    conn.send(JSON.stringify(msg));
}

//send Websocket message
function message(to, body){
    var msg = {
        id: uid(30),
        type: 'message',
        from: me,
        to: to,
        body: body
    }
    console.log('sending', msg);
    conn.send(JSON.stringify(msg));
}



//generate random string
function uid(len) {
    var buffer = [];
    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

    for (var i = 0; i < len; ++i) {
        var rand = Math.floor(Math.random() * (chars.length + 1));
        buffer.push(chars[rand]);
    }

    return buffer.join('');
};
</script>

<div style="float: right">
    <strong>Logged in as: </strong><br><span id="myName"></span>
</div>

<h3>Login</h3>
<input type="button" value="Alice" onClick="login('alice')">
<input type="button" value="Bob" onClick="login('bob')"><br>

<h3>Invite</h3>
<input type="button" value="Alice" onClick="invite('alice')">
<input type="button" value="Bob" onClick="invite('bob')"><br>

<hr>

<video id="localVideo" autoplay style="width: 300px; float: left; margin-right: 20px; border: 1px solid grey;"></video>
<video id="remoteVideo" autoplay style="width: 300px; border: 1px solid grey;"></video>

</body>
</html>
